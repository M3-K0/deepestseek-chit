<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>DeepSeek R1 Custom Chat</title>
    <meta name="theme-color" content="#1A1A2E">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkRlZXBTZWVrIFIxIEN1c3RvbSBDaGF0IiwKICAic2hvcnRfbmFtZSI6ICJEZWVwU2VlayBDaGF0IiwKICAiZGVzY3JpcHRpb24iOiAiQ3VzdG9tIERlZXBTZWVrIFIxIENoYXQgSW50ZXJmYWNlIiwKICAic3RhcnRfdXJsIjogIi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMxQTFBMkUiLAogICJ0aGVtZV9jb2xvciI6ICIjMUExQTJFIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTmpRaUlHaGxhV2RvZEQwaU5qUWlJSFpwWlhkQ2IzZzlJakFnTUNCMk5qUWdOalFpSUdacGJHdzlJaU0yUXpZelJrWWlQanh5WldOMElIZHBaSFJvUFNJMk5DSWdhR1ZwWjJoMFBTSTJOQ0lpSUhKNFBTSTRJaUJtYVd4c1BTSWpOa00yTTBaR0lpOCtQQzl6ZG1jKyIsInNpemVzIjogIjY0eDY0IiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0KICBdCn0=">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1A1A2E;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            margin: 0;
            padding: 0;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .header {
            background: #2D2D44;
            padding: 16px 20px;
            text-align: center;
            color: white;
            border-bottom: 2px solid #3D3D5C;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
        }

        .settings-btn {
            background: #3D3D5C;
            border: 2px solid #4A4A6A;
            border-radius: 8px;
            width: 40px;
            height: 40px;
            color: white;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .settings-btn:hover {
            background: #4A4A6A;
        }

        .api-setup {
            background: #2D2D44;
            padding: 16px 20px;
            display: flex;
            gap: 12px;
            border-bottom: 2px solid #3D3D5C;
            flex-shrink: 0;
        }

        .api-setup input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #4A4A6A;
            border-radius: 8px;
            background: #3D3D5C;
            color: white;
            font-size: 14px;
        }
        
        .api-setup input:focus {
            outline: none;
            border-color: #6C63FF;
        }
        
        .api-setup input::placeholder {
            color: #9A9AB0;
        }

        .api-setup button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            background: #6C63FF;
            color: white;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }
        
        .api-setup button:hover {
            background: #5A52E5;
        }

        .settings-panel {
            background: #2D2D44;
            padding: 20px;
            display: none;
            border-bottom: 2px solid #3D3D5C;
            max-height: 60vh;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .setting-group label {
            font-weight: 600;
            color: white;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .setting-group input, .setting-group select {
            padding: 8px 12px;
            border: 2px solid #4A4A6A;
            border-radius: 6px;
            font-size: 14px;
            background: #3D3D5C;
            color: white;
        }
        
        .setting-group input:focus, .setting-group select:focus {
            outline: none;
            border-color: #6C63FF;
        }
        
        .setting-group input[type="range"] {
            -webkit-appearance: none;
            height: 6px;
            background: #4A4A6A;
            border-radius: 3px;
            outline: none;
            border: none;
        }
        
        .setting-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #6C63FF;
            border-radius: 50%;
            cursor: pointer;
        }

        .prompt-section {
            grid-column: 1 / -1;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .prompt-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .prompt-tab {
            padding: 8px 16px;
            border: 2px solid #4A4A6A;
            border-radius: 6px;
            background: #3D3D5C;
            color: #9A9AB0;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        
        .prompt-tab.active {
            background: #6C63FF;
            color: white;
            border-color: #6C63FF;
        }
        
        .prompt-content {
            display: none;
        }
        
        .prompt-content.active {
            display: block;
        }

        .prompt-textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 2px solid #4A4A6A;
            border-radius: 6px;
            font-size: 14px;
            resize: vertical;
            background: #3D3D5C;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.5;
            box-sizing: border-box;
        }
        
        .prompt-textarea:focus {
            outline: none;
            border-color: #6C63FF;
        }
        
        .prompt-textarea::placeholder {
            color: #9A9AB0;
        }

        .preset-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .preset-btn {
            padding: 8px 14px;
            border: 2px solid #4A4A6A;
            border-radius: 16px;
            background: #3D3D5C;
            color: white;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }

        .preset-btn:hover {
            background: #6C63FF;
            border-color: #6C63FF;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 16px 20px;
            padding-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: #1A1A2E;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            height: 0; /* Forces flex to work properly */
        }

        .message {
            max-width: 85%;
            padding: 15px 20px;
            border-radius: 20px;
            font-size: 16px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .user-message {
            background: #6C63FF;
            margin-left: auto;
            border-bottom-right-radius: 5px;
            color: white;
        }

        .bot-message {
            background: #2D2D44;
            border: 2px solid #3D3D5C;
            margin-right: auto;
            border-bottom-left-radius: 5px;
            color: white;
        }

        .thinking {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.4);
            color: #fff3cd;
            font-style: italic;
        }

        .message-wrapper {
            display: flex;
            flex-direction: column;
            max-width: 85%;
            margin-bottom: 12px;
        }

        .message-wrapper.user {
            margin-left: auto;
            align-items: flex-end;
        }

        .message-wrapper.bot {
            margin-right: auto;
            align-items: flex-start;
        }

        .message-actions {
            display: flex;
            gap: 6px;
            margin-top: 6px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .message-wrapper:hover .message-actions {
            opacity: 1;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            color: #ccc;
            cursor: pointer;
            font-size: 12px;
            padding: 4px 8px;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .retry-btn:hover {
            background: #6C63FF;
            border-color: #6C63FF;
        }

        .copy-btn:hover {
            background: #4CAF50;
            border-color: #4CAF50;
        }

        .edit-btn:hover {
            background: #FF9800;
            border-color: #FF9800;
        }

        .delete-btn:hover {
            background: #f44336;
            border-color: #f44336;
        }

        .input-container {
            padding: 16px 20px;
            background: #2D2D44;
            border-top: 2px solid #3D3D5C;
            flex-shrink: 0;
            position: sticky;
            bottom: 0;
            z-index: 100;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .message-input {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid #4A4A6A;
            border-radius: 12px;
            background: #3D3D5C;
            color: white;
            font-size: 16px;
            resize: none;
            min-height: 50px;
            max-height: 120px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .message-input:focus {
            outline: none;
            border-color: #6C63FF;
        }
        
        .message-input::placeholder {
            color: #9A9AB0;
        }

        .send-button {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 12px;
            background: #6C63FF;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .send-button:hover {
            background: #5A52E5;
        }

        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .status {
            padding: 8px 20px;
            text-align: center;
            color: #9A9AB0;
            font-size: 14px;
            background: #2D2D44;
            border-bottom: 1px solid #3D3D5C;
            flex-shrink: 0;
        }

        .connected { color: #4CAF50; }
        .error { color: #f44336; }

        .clear-btn {
            background: #3D3D5C;
            border: 2px solid #4A4A6A;
            border-radius: 8px;
            width: 40px;
            height: 40px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .clear-btn:hover {
            background: #D32F2F;
            border-color: #D32F2F;
        }

        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .message-wrapper {
                max-width: 90%;
            }
            
            .message {
                font-size: 15px;
            }
            
            .message-actions {
                opacity: 1;
            }
            
            .input-container {
                padding: 16px;
            }
            
            .header {
                padding: 16px;
            }
            
            .api-setup {
                padding: 16px;
                flex-direction: column;
            }
            
            .api-setup input {
                margin-bottom: 12px;
            }
            
            .settings-panel {
                padding: 20px;
            }
            
            .prompt-tabs {
                flex-wrap: wrap;
            }
            
            .preset-buttons {
                gap: 8px;
            }
            
            .preset-btn {
                font-size: 11px;
                padding: 8px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <button class="settings-btn" onclick="toggleSettings()">‚öôÔ∏è</button>
        <h1>ü§ñ DeepSeek R1 Custom</h1>
        <div style="display: flex; gap: 8px;">
            <button class="clear-btn" onclick="exportConversation()" title="Export to OneDrive">üíæ</button>
            <button class="clear-btn" onclick="shareConversation()" title="Share" style="display: none;" id="shareBtn">üì§</button>
            <button class="clear-btn" onclick="importConversation()" title="Import from OneDrive">üìÅ</button>
            <button class="clear-btn" id="changeApiKeyBtn" onclick="changeApiKey()" style="display: none;" title="Change API Key">üîë</button>
            <button class="clear-btn" onclick="clearChat()">üóëÔ∏è</button>
        </div>
    </div>

    <div class="api-setup" id="apiSetup">
        <input type="password" id="apiKey" placeholder="Enter your DeepSeek API key..." />
        <button onclick="setApiKey()">Set Key</button>
    </div>

    <div class="settings-panel" id="settingsPanel">
        <div class="settings-grid">
            <div class="setting-group">
                <label>Model</label>
                <select id="model">
                    <option value="deepseek-reasoner">DeepSeek R1 (Reasoner)</option>
                    <option value="deepseek-chat">DeepSeek Chat</option>
                </select>
            </div>
            
            <div class="setting-group">
                <label>Temperature</label>
                <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.7" oninput="updateTempLabel()">
                <span id="tempLabel">0.7</span>
            </div>
            
            <div class="setting-group">
                <label>Max Tokens</label>
                <input type="number" id="maxTokens" value="4000" min="1" max="8000">
            </div>
            
            <div class="setting-group">
                <label>Top P</label>
                <input type="range" id="topP" min="0" max="1" step="0.05" value="0.95" oninput="updateTopPLabel()">
                <span id="topPLabel">0.95</span>
            </div>
            
            <div class="setting-group">
                <label>Frequency Penalty</label>
                <input type="range" id="freqPenalty" min="-2" max="2" step="0.1" value="0" oninput="updateFreqLabel()">
                <span id="freqLabel">0.0</span>
            </div>
            
            <div class="setting-group">
                <label>Presence Penalty</label>
                <input type="range" id="presPenalty" min="-2" max="2" step="0.1" value="0" oninput="updatePresLabel()">
                <span id="presLabel">0.0</span>
            </div>
            
            <div class="setting-group">
                <label>Configuration</label>
                <div style="display: flex; gap: 8px; margin-top: 8px;">
                    <button class="preset-btn" onclick="saveConfig()" style="flex: 1;">üíæ Save Config</button>
                    <button class="preset-btn" onclick="loadConfig()" style="flex: 1;">üìÇ Load Config</button>
                    <button class="preset-btn" onclick="resetConfig()" style="flex: 1;">üîÑ Reset</button>
                </div>
                <input type="file" id="configFile" accept=".json" style="display: none;" onchange="handleConfigFile(event)">
            </div>
            
            <div class="setting-group prompt-section">
                <label>AI Personality & Behavior</label>
                
                <div class="prompt-tabs">
                    <button class="prompt-tab active" onclick="switchPromptTab('base')">üìã Base Instructions</button>
                    <button class="prompt-tab" onclick="switchPromptTab('personality')">üé≠ Personality</button>
                    <button class="prompt-tab" onclick="switchPromptTab('memory')">üß† Memory Context</button>
                </div>
                
                <div class="prompt-content active" id="basePromptContent">
                    <textarea id="basePrompt" class="prompt-textarea" placeholder="Enter core instructions for how the AI should respond (e.g., format, length, technical level)...">You are a helpful AI assistant. Provide clear, accurate, and well-structured responses. Be concise but thorough in your explanations.</textarea>
                </div>
                
                <div class="prompt-content" id="personalityPromptContent">
                    <textarea id="personalityPrompt" class="prompt-textarea" placeholder="Define the AI's personality, tone, and communication style (e.g., friendly, professional, creative, analytical)...">Be friendly and engaging while maintaining professionalism. Use a conversational tone and show enthusiasm for helping users solve problems.</textarea>
                </div>
                
                <div class="prompt-content" id="memoryPromptContent">
                    <textarea id="memoryContext" class="prompt-textarea" placeholder="Enter persistent context information like current projects, preferences, important facts to remember across conversations...">## User Profile (moke)
- Expert developer: Kotlin, Java, Python, TypeScript, JavaScript
- Platform: Windows 11 host + Ubuntu VM
- Focus: Android development, messaging apps, automation
- Tools: Android Studio, ADB, Git, Node.js, Flutter
- Architecture: Clean architecture, service-based patterns

## Communication Style
- Casual, direct, concise responses (under 4 lines unless detail requested)
- Friendly but efficient, minimal preamble/postamble
- Don't over-explain basics to experienced developer

## Current Projects
- DeepSeek chat interface improvements (OneDrive integration, mobile optimization)
- Marketplace monitor project (React PWA + Node.js backend)
- Android development and automation tools

## Working Environment
- Claude Code CLI for development workflow
- Command line automation and project setup
- Integration with development tools and services</textarea>
                    <div style="margin-top: 10px; font-size: 12px; color: #9A9AB0;">
                        This context is included with every API call along with recent messages, but saved separately to reduce token usage.
                    </div>
                </div>
                
                <div class="preset-buttons">
                    <button class="preset-btn" onclick="setPreset('coding')">üîß Coding Assistant</button>
                    <button class="preset-btn" onclick="setPreset('creative')">üé® Creative Writer</button>
                    <button class="preset-btn" onclick="setPreset('analyst')">üìä Data Analyst</button>
                    <button class="preset-btn" onclick="setPreset('teacher')">üë®‚Äçüè´ Teacher</button>
                    <button class="preset-btn" onclick="setPreset('researcher')">üî¨ Researcher</button>
                </div>
            </div>
        </div>
    </div>

    <div class="status" id="status">Enter your API key to start chatting</div>

    <div class="chat-container" id="chatContainer">
        <div class="message-wrapper bot">
            <div class="message bot-message">
                üëã Hi! I'm DeepSeek R1 with full customization. Set your API key, configure your settings, and let's chat!
            </div>
            <div class="message-actions">
                <button class="action-btn copy-btn" onclick="copyMessage('üëã Hi! I\'m DeepSeek R1 with full customization. Set your API key, configure your settings, and let\'s chat!')" title="Copy message">üìã</button>
                <button class="action-btn delete-btn" onclick="deleteMessage(this.closest('.message-wrapper'))" title="Delete message">üóëÔ∏è</button>
            </div>
        </div>
    </div>

    <div class="input-container">
        <div class="input-wrapper">
            <textarea 
                id="messageInput" 
                class="message-input" 
                placeholder="Type your message..."
                disabled
            ></textarea>
            <button class="send-button" id="sendButton" onclick="sendMessage()" disabled>
                ‚û§
            </button>
        </div>
    </div>

    <script>
        let apiKey = '';
        let isConnected = false;
        let isThinking = false;
        let conversationHistory = [];
        let currentConversationId = null;
        let contextLimit = 10; // Only send last 10 messages to API

        const presets = {
            coding: {
                base: "You are an expert software engineer and coding assistant. Provide clean, efficient code with clear explanations. Always consider best practices, security, and performance. Format code blocks properly and include comments where helpful.",
                personality: "Be methodical and precise, but also encouraging. Show excitement about elegant solutions and help users understand not just what to do, but why. Use technical language appropriately but explain complex concepts clearly."
            },
            creative: {
                base: "You are a creative writing assistant. Help with storytelling, poetry, creative projects, and artistic endeavors. Provide constructive feedback and inspire new ideas. Structure your responses to be engaging and imaginative.",
                personality: "Be imaginative, inspiring, and enthusiastic about creative expression. Use vivid language and encourage experimentation. Show genuine interest in artistic vision and help bring ideas to life with passion."
            },
            analyst: {
                base: "You are a data analyst and researcher. Provide thorough analysis, break down complex topics systematically, use logical reasoning, and support conclusions with evidence. Present findings clearly with proper structure.",
                personality: "Be analytical and objective, but also approachable. Show curiosity about data patterns and insights. Present information in a way that's both rigorous and accessible, helping users understand the bigger picture."
            },
            teacher: {
                base: "You are a patient teacher and tutor. Explain concepts clearly using examples, break down complex topics into digestible parts, and provide step-by-step guidance. Adapt explanations to the user's level.",
                personality: "Be patient, encouraging, and supportive. Celebrate learning progress and create a safe space for questions. Use analogies and real-world examples to make concepts relatable and memorable."
            },
            researcher: {
                base: "You are a research assistant. Help with finding information, analyzing sources, summarizing findings, and organizing research systematically. Provide comprehensive yet focused responses with proper citations when relevant.",
                personality: "Be thorough and methodical, but also curious and engaging. Show enthusiasm for discovery and learning. Present research findings in an organized, accessible way that highlights key insights."
            }
        };

        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            const isVisible = panel.style.display === 'block';
            panel.style.display = isVisible ? 'none' : 'block';
        }

        function setPreset(type) {
            if (presets[type]) {
                document.getElementById('basePrompt').value = presets[type].base;
                document.getElementById('personalityPrompt').value = presets[type].personality;
            }
        }
        
        function switchPromptTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.prompt-tab').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="switchPromptTab('${tab}')"]`).classList.add('active');
            
            // Update content visibility
            document.querySelectorAll('.prompt-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tab + 'PromptContent').classList.add('active');
        }

        function updateTempLabel() {
            document.getElementById('tempLabel').textContent = document.getElementById('temperature').value;
        }

        function updateTopPLabel() {
            document.getElementById('topPLabel').textContent = document.getElementById('topP').value;
        }

        function updateFreqLabel() {
            document.getElementById('freqLabel').textContent = document.getElementById('freqPenalty').value;
        }

        function updatePresLabel() {
            document.getElementById('presLabel').textContent = document.getElementById('presPenalty').value;
        }

        function clearChat() {
            if (confirm('Clear all messages?')) {
                document.getElementById('chatContainer').innerHTML = '';
                conversationHistory = [];
                currentConversationId = null;
            }
        }

        // Export conversation for OneDrive
        async function exportConversation() {
            if (conversationHistory.length === 0) {
                alert('No conversation to export');
                return;
            }
            
            const conversationData = {
                id: currentConversationId || 'conversation-' + Date.now(),
                timestamp: new Date().toISOString(),
                messages: conversationHistory,
                memoryContext: document.getElementById('memoryContext').value,
                settings: {
                    model: document.getElementById('model').value,
                    temperature: document.getElementById('temperature').value,
                    basePrompt: document.getElementById('basePrompt').value,
                    personalityPrompt: document.getElementById('personalityPrompt').value
                }
            };
            
            const filename = `deepseek-conversation-${new Date().toISOString().split('T')[0]}-${Date.now()}.json`;
            const fileContent = JSON.stringify(conversationData, null, 2);
            
            // Try modern File System Access API first (Chrome/Edge on desktop)
            if (window.showSaveFilePicker) {
                try {
                    const fileHandle = await window.showSaveFilePicker({
                        suggestedName: filename,
                        types: [{
                            description: 'JSON files',
                            accept: { 'application/json': ['.json'] }
                        }]
                    });
                    
                    const writable = await fileHandle.createWritable();
                    await writable.write(fileContent);
                    await writable.close();
                    
                    const status = document.getElementById('status');
                    const originalText = status.innerHTML;
                    status.innerHTML = '<span class="connected">‚úì Conversation saved directly to chosen location</span>';
                    setTimeout(() => {
                        status.innerHTML = originalText;
                    }, 3000);
                    return;
                } catch (error) {
                    // User cancelled or error occurred, fall back to download
                    console.log('File picker cancelled or failed, using download fallback');
                }
            }
            
            // Fallback: Download file (works on all browsers/mobile)
            const blob = new Blob([fileContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            const status = document.getElementById('status');
            const originalText = status.innerHTML;
            status.innerHTML = '<span class="connected">‚úì Conversation downloaded! Move to OneDrive folder</span>';
            setTimeout(() => {
                status.innerHTML = originalText;
            }, 3000);
        }

        // Share conversation on mobile
        async function shareConversation() {
            if (conversationHistory.length === 0) {
                alert('No conversation to share');
                return;
            }
            
            const conversationData = {
                id: currentConversationId || 'conversation-' + Date.now(),
                timestamp: new Date().toISOString(),
                messages: conversationHistory,
                memoryContext: document.getElementById('memoryContext').value,
                settings: {
                    model: document.getElementById('model').value,
                    temperature: document.getElementById('temperature').value,
                    basePrompt: document.getElementById('basePrompt').value,
                    personalityPrompt: document.getElementById('personalityPrompt').value
                }
            };
            
            const filename = `deepseek-conversation-${new Date().toISOString().split('T')[0]}.json`;
            const fileContent = JSON.stringify(conversationData, null, 2);
            
            if (navigator.share && navigator.canShare) {
                try {
                    const blob = new Blob([fileContent], { type: 'application/json' });
                    const file = new File([blob], filename, { type: 'application/json' });
                    
                    if (navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            title: 'DeepSeek Conversation',
                            text: 'Sharing my DeepSeek chat conversation',
                            files: [file]
                        });
                        return;
                    }
                } catch (error) {
                    console.log('Web Share API failed, falling back to copy');
                }
            }
            
            // Fallback: Copy conversation as text
            const textConversation = conversationHistory.map(msg => 
                `${msg.role === 'user' ? 'You' : 'AI'}: ${msg.content}`
            ).join('\n\n');
            
            try {
                await navigator.clipboard.writeText(textConversation);
                const status = document.getElementById('status');
                const originalText = status.innerHTML;
                status.innerHTML = '<span class="connected">‚úì Conversation copied to clipboard</span>';
                setTimeout(() => {
                    status.innerHTML = originalText;
                }, 3000);
            } catch (error) {
                // Final fallback
                exportConversation();
            }
        }

        // Load conversation from browser storage on page load
        function loadAutoSavedConversation() {
            const saved = localStorage.getItem('deepseek-current-conversation');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    if (data.messages && data.messages.length > 0) {
                        // Ask user if they want to restore the conversation
                        if (confirm('Restore previous conversation?')) {
                            conversationHistory = data.messages;
                            currentConversationId = data.id;
                            if (data.memoryContext) {
                                document.getElementById('memoryContext').value = data.memoryContext;
                            }
                            rebuildChatDisplay();
                        }
                    }
                } catch (error) {
                    console.error('Error loading auto-saved conversation:', error);
                }
            }
        }

        function importConversation() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            
                            // Load conversation
                            conversationHistory = data.messages || [];
                            currentConversationId = data.id;
                            
                            // Load memory context
                            if (data.memoryContext) {
                                document.getElementById('memoryContext').value = data.memoryContext;
                            }
                            
                            // Load settings
                            if (data.settings) {
                                document.getElementById('model').value = data.settings.model || 'deepseek-reasoner';
                                document.getElementById('temperature').value = data.settings.temperature || '0.7';
                                document.getElementById('basePrompt').value = data.settings.basePrompt || '';
                                document.getElementById('personalityPrompt').value = data.settings.personalityPrompt || '';
                                updateTempLabel();
                            }
                            
                            // Rebuild chat display
                            rebuildChatDisplay();
                            
                            const status = document.getElementById('status');
                            const originalText = status.innerHTML;
                            status.innerHTML = '<span class="connected">‚úì Conversation imported successfully</span>';
                            setTimeout(() => {
                                status.innerHTML = originalText;
                            }, 3000);
                            
                        } catch (error) {
                            alert('Error importing conversation: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function rebuildChatDisplay() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = '';
            
            conversationHistory.forEach(msg => {
                addMessage(msg.content, msg.role === 'user', false);
            });
        }

        // Auto-export conversation to browser storage
        setInterval(() => {
            if (conversationHistory.length > 0) {
                const conversationData = {
                    id: currentConversationId || 'conversation-' + Date.now(),
                    timestamp: new Date().toISOString(),
                    messages: conversationHistory,
                    memoryContext: document.getElementById('memoryContext').value
                };
                localStorage.setItem('deepseek-current-conversation', JSON.stringify(conversationData));
            }
        }, 10000); // Auto-save every 10 seconds to browser storage

        function copyMessage(content) {
            navigator.clipboard.writeText(content).then(() => {
                // Show brief feedback
                const status = document.getElementById('status');
                const originalText = status.innerHTML;
                status.innerHTML = '<span class="connected">‚úì Copied to clipboard</span>';
                setTimeout(() => {
                    status.innerHTML = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = content;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
            });
        }

        function deleteMessage(messageWrapper) {
            if (confirm('Delete this message?')) {
                const messageDiv = messageWrapper.querySelector('.message');
                const content = messageDiv.textContent;
                
                // Remove from conversation history
                conversationHistory = conversationHistory.filter(msg => msg.content !== content);
                
                // Remove from DOM
                messageWrapper.remove();
            }
        }

        function editMessage(messageDiv, originalContent) {
            const currentContent = messageDiv.textContent;
            const newContent = prompt('Edit message:', currentContent);
            
            if (newContent !== null && newContent.trim() !== '') {
                // Update the message display
                messageDiv.innerHTML = newContent.replace(/\n/g, '<br>');
                
                // Update conversation history
                const msgIndex = conversationHistory.findIndex(msg => msg.content === originalContent);
                if (msgIndex !== -1) {
                    conversationHistory[msgIndex].content = newContent;
                }
            }
        }

        async function regenerateResponse(messageWrapper) {
            if (isThinking) return;
            
            const messageDiv = messageWrapper.querySelector('.message');
            const originalContent = messageDiv.textContent;
            
            // Remove this AI response from conversation history
            conversationHistory = conversationHistory.filter(msg => msg.content !== originalContent);
            
            // Remove the message wrapper
            messageWrapper.remove();
            
            // Get the last user message to regenerate response
            const lastUserMsg = conversationHistory[conversationHistory.length - 1];
            if (lastUserMsg && lastUserMsg.role === 'user') {
                // Temporarily remove the last user message from history so sendMessage logic works
                const userContent = lastUserMsg.content;
                conversationHistory.pop();
                
                // Show thinking indicator
                isThinking = true;
                document.getElementById('sendButton').disabled = true;
                const thinkingDiv = addMessage('', false, true);
                
                try {
                    // Build messages array with smart context system
                    const messages = [];
                    
                    const basePrompt = document.getElementById('basePrompt').value.trim();
                    const personalityPrompt = document.getElementById('personalityPrompt').value.trim();
                    const memoryContext = document.getElementById('memoryContext').value.trim();
                    
                    // Build system prompt
                    let systemPrompt = '';
                    if (basePrompt) {
                        systemPrompt += basePrompt;
                    }
                    if (personalityPrompt) {
                        if (systemPrompt) systemPrompt += '\n\n';
                        systemPrompt += 'Personality and Communication Style: ' + personalityPrompt;
                    }
                    if (memoryContext) {
                        if (systemPrompt) systemPrompt += '\n\n';
                        systemPrompt += 'Important Context & Memory: ' + memoryContext;
                    }
                    
                    if (systemPrompt) {
                        messages.push({
                            role: 'system',
                            content: systemPrompt
                        });
                    }
                    
                    // Add only recent conversation history (last N messages)
                    const recentHistory = conversationHistory.slice(-contextLimit);
                    messages.push(...recentHistory);
                    
                    // Add the user message
                    messages.push({
                        role: 'user',
                        content: userContent
                    });

                    const requestBody = {
                        model: document.getElementById('model').value,
                        messages: messages,
                        max_tokens: parseInt(document.getElementById('maxTokens').value),
                        temperature: parseFloat(document.getElementById('temperature').value),
                        top_p: parseFloat(document.getElementById('topP').value),
                        frequency_penalty: parseFloat(document.getElementById('freqPenalty').value),
                        presence_penalty: parseFloat(document.getElementById('presPenalty').value)
                    };

                    const response = await fetch('https://api.deepseek.com/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    thinkingDiv.remove();
                    
                    // Add the user message back to history
                    conversationHistory.push({
                        role: 'user',
                        content: userContent
                    });
                    
                    if (data.choices && data.choices[0] && data.choices[0].message) {
                        const content = data.choices[0].message.content;
                        addMessage(content, false);
                    } else {
                        addMessage('Sorry, I received an unexpected response format.', false);
                    }
                    
                } catch (error) {
                    console.error('Error:', error);
                    thinkingDiv.remove();
                    addMessage(`Error: ${error.message}. Please check your API key and try again.`, false);
                }
                
                isThinking = false;
                document.getElementById('sendButton').disabled = false;
            }
        }

        function setApiKey() {
            const keyInput = document.getElementById('apiKey');
            apiKey = keyInput.value.trim();
            
            if (apiKey) {
                // Store API key in localStorage (base64 encoded)
                localStorage.setItem('deepseek-api-key', btoa(apiKey));
                
                isConnected = true;
                document.getElementById('status').innerHTML = '<span class="connected">‚úì API key set! Ready to chat</span>';
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendButton').disabled = false;
                keyInput.value = '';
                
                // Hide API setup section after successful setup
                document.getElementById('apiSetup').style.display = 'none';
                
                // Show change API key button
                document.getElementById('changeApiKeyBtn').style.display = 'block';
                
                // Don't auto-focus to prevent scrolling issues
            } else {
                alert('Please enter a valid API key');
            }
        }
        
        function changeApiKey() {
            document.getElementById('apiSetup').style.display = 'flex';
            document.getElementById('changeApiKeyBtn').style.display = 'none';
            document.getElementById('apiKey').focus();
        }
        
        function loadSavedApiKey() {
            const savedKey = localStorage.getItem('deepseek-api-key');
            if (savedKey) {
                try {
                    apiKey = atob(savedKey);
                    if (apiKey) {
                        isConnected = true;
                        document.getElementById('status').innerHTML = '<span class="connected">‚úì API key loaded! Ready to chat</span>';
                        document.getElementById('messageInput').disabled = false;
                        document.getElementById('sendButton').disabled = false;
                        
                        // Hide API setup section
                        document.getElementById('apiSetup').style.display = 'none';
                        
                        // Show change API key button
                        document.getElementById('changeApiKeyBtn').style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error loading saved API key:', error);
                    localStorage.removeItem('deepseek-api-key');
                }
            }
        }

        function addMessage(content, isUser = false, isThinking = false) {
            const chatContainer = document.getElementById('chatContainer');
            
            if (isThinking) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message thinking';
                messageDiv.innerHTML = 'ü§î Thinking...';
                chatContainer.appendChild(messageDiv);
                
                // Auto-scroll for thinking indicator
                setTimeout(() => {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }, 50);
                return messageDiv;
            } else {
                const messageWrapper = document.createElement('div');
                messageWrapper.className = `message-wrapper ${isUser ? 'user' : 'bot'}`;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
                messageDiv.innerHTML = content.replace(/\n/g, '<br>');
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';
                
                // Copy button for all messages
                const copyBtn = document.createElement('button');
                copyBtn.className = 'action-btn copy-btn';
                copyBtn.innerHTML = 'üìã';
                copyBtn.title = 'Copy message';
                copyBtn.onclick = () => copyMessage(content);
                actionsDiv.appendChild(copyBtn);
                
                // Delete button for all messages
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'action-btn delete-btn';
                deleteBtn.innerHTML = 'üóëÔ∏è';
                deleteBtn.title = 'Delete message';
                deleteBtn.onclick = () => deleteMessage(messageWrapper);
                actionsDiv.appendChild(deleteBtn);
                
                if (isUser) {
                    // Edit button for user messages
                    const editBtn = document.createElement('button');
                    editBtn.className = 'action-btn edit-btn';
                    editBtn.innerHTML = '‚úèÔ∏è';
                    editBtn.title = 'Edit message';
                    editBtn.onclick = () => editMessage(messageDiv, content);
                    actionsDiv.appendChild(editBtn);
                } else {
                    // Retry button for AI messages
                    const retryBtn = document.createElement('button');
                    retryBtn.className = 'action-btn retry-btn';
                    retryBtn.innerHTML = 'üîÑ';
                    retryBtn.title = 'Regenerate response';
                    retryBtn.onclick = () => regenerateResponse(messageWrapper);
                    actionsDiv.appendChild(retryBtn);
                }
                
                messageWrapper.appendChild(messageDiv);
                messageWrapper.appendChild(actionsDiv);
                chatContainer.appendChild(messageWrapper);
                
                // Add to conversation history
                conversationHistory.push({
                    role: isUser ? 'user' : 'assistant',
                    content: content
                });
                
                // Only auto-scroll if user is near bottom or if this is a new message from user
                const isNearBottom = chatContainer.scrollTop + chatContainer.clientHeight >= chatContainer.scrollHeight - 150;
                const shouldAutoScroll = isNearBottom || isUser;
                
                if (shouldAutoScroll) {
                    setTimeout(() => {
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }, 50);
                }
                return messageDiv;
            }
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || !isConnected || isThinking) return;
            
            addMessage(message, true);
            messageInput.value = '';
            
            isThinking = true;
            document.getElementById('sendButton').disabled = true;
            const thinkingDiv = addMessage('', false, true);
            
            try {
                // Build messages array with smart context system
                const messages = [];
                
                const basePrompt = document.getElementById('basePrompt').value.trim();
                const personalityPrompt = document.getElementById('personalityPrompt').value.trim();
                const memoryContext = document.getElementById('memoryContext').value.trim();
                
                // Build system prompt
                let systemPrompt = '';
                if (basePrompt) {
                    systemPrompt += basePrompt;
                }
                if (personalityPrompt) {
                    if (systemPrompt) systemPrompt += '\n\n';
                    systemPrompt += 'Personality and Communication Style: ' + personalityPrompt;
                }
                if (memoryContext) {
                    if (systemPrompt) systemPrompt += '\n\n';
                    systemPrompt += 'Important Context & Memory: ' + memoryContext;
                }
                
                if (systemPrompt) {
                    messages.push({
                        role: 'system',
                        content: systemPrompt
                    });
                }
                
                // Add only recent conversation history (last N messages)
                const recentHistory = conversationHistory.slice(-contextLimit);
                messages.push(...recentHistory);
                
                // Add current message
                messages.push({
                    role: 'user',
                    content: message
                });

                const requestBody = {
                    model: document.getElementById('model').value,
                    messages: messages,
                    max_tokens: parseInt(document.getElementById('maxTokens').value),
                    temperature: parseFloat(document.getElementById('temperature').value),
                    top_p: parseFloat(document.getElementById('topP').value),
                    frequency_penalty: parseFloat(document.getElementById('freqPenalty').value),
                    presence_penalty: parseFloat(document.getElementById('presPenalty').value)
                };

                const response = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                thinkingDiv.remove();
                
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    const content = data.choices[0].message.content;
                    addMessage(content, false);
                } else {
                    addMessage('Sorry, I received an unexpected response format.', false);
                }
                
            } catch (error) {
                console.error('Error:', error);
                thinkingDiv.remove();
                addMessage(`Error: ${error.message}. Please check your API key and try again.`, false);
                document.getElementById('status').innerHTML = '<span class="error">‚ùå Connection error</span>';
            }
            
            isThinking = false;
            document.getElementById('sendButton').disabled = false;
            // Don't auto-focus to prevent scrolling issues
        }

        // Configuration management
        function saveConfig() {
            try {
                const config = {
                    model: document.getElementById('model').value,
                    temperature: document.getElementById('temperature').value,
                    maxTokens: document.getElementById('maxTokens').value,
                    topP: document.getElementById('topP').value,
                    freqPenalty: document.getElementById('freqPenalty').value,
                    presPenalty: document.getElementById('presPenalty').value,
                    basePrompt: document.getElementById('basePrompt').value,
                    personalityPrompt: document.getElementById('personalityPrompt').value,
                    memoryContext: document.getElementById('memoryContext').value,
                    timestamp: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `deepseek-config-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // Close settings panel after saving
                document.getElementById('settingsPanel').style.display = 'none';
                
                // Show success message
                document.getElementById('status').innerHTML = '<span class="connected">‚úì Configuration saved!</span>';
                setTimeout(() => {
                    if (isConnected) {
                        document.getElementById('status').innerHTML = '<span class="connected">‚úì API key set! Ready to chat</span>';
                    }
                }, 2000);
            } catch (error) {
                alert('Error saving configuration: ' + error.message);
            }
        }
        
        function loadConfig() {
            document.getElementById('configFile').click();
        }
        
        function handleConfigFile(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const config = JSON.parse(e.target.result);
                        applyConfig(config);
                        
                        // Close settings panel after loading
                        document.getElementById('settingsPanel').style.display = 'none';
                        
                        // Show success message
                        document.getElementById('status').innerHTML = '<span class="connected">‚úì Configuration loaded!</span>';
                        setTimeout(() => {
                            if (isConnected) {
                                document.getElementById('status').innerHTML = '<span class="connected">‚úì API key set! Ready to chat</span>';
                            }
                        }, 2000);
                    } catch (error) {
                        alert('Error loading configuration: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        }
        
        function applyConfig(config) {
            if (config.model) document.getElementById('model').value = config.model;
            if (config.temperature) {
                document.getElementById('temperature').value = config.temperature;
                updateTempLabel();
            }
            if (config.maxTokens) document.getElementById('maxTokens').value = config.maxTokens;
            if (config.topP) {
                document.getElementById('topP').value = config.topP;
                updateTopPLabel();
            }
            if (config.freqPenalty) {
                document.getElementById('freqPenalty').value = config.freqPenalty;
                updateFreqLabel();
            }
            if (config.presPenalty) {
                document.getElementById('presPenalty').value = config.presPenalty;
                updatePresLabel();
            }
            if (config.basePrompt) document.getElementById('basePrompt').value = config.basePrompt;
            if (config.personalityPrompt) document.getElementById('personalityPrompt').value = config.personalityPrompt;
            if (config.memoryContext) document.getElementById('memoryContext').value = config.memoryContext;
        }
        
        function resetConfig() {
            if (confirm('Reset all settings to default values?')) {
                document.getElementById('model').value = 'deepseek-reasoner';
                document.getElementById('temperature').value = '0.7';
                document.getElementById('maxTokens').value = '4000';
                document.getElementById('topP').value = '0.95';
                document.getElementById('freqPenalty').value = '0';
                document.getElementById('presPenalty').value = '0';
                document.getElementById('basePrompt').value = 'You are a helpful AI assistant. Provide clear, accurate, and well-structured responses. Be concise but thorough in your explanations.';
                document.getElementById('personalityPrompt').value = 'Be friendly and engaging while maintaining professionalism. Use a conversational tone and show enthusiasm for helping users solve problems.';
                document.getElementById('memoryContext').value = '';
                
                updateTempLabel();
                updateTopPLabel();
                updateFreqLabel();
                updatePresLabel();
                
                // Close settings panel after reset
                document.getElementById('settingsPanel').style.display = 'none';
                
                // Show success message
                document.getElementById('status').innerHTML = '<span class="connected">‚úì Configuration reset!</span>';
                setTimeout(() => {
                    if (isConnected) {
                        document.getElementById('status').innerHTML = '<span class="connected">‚úì API key set! Ready to chat</span>';
                    }
                }, 2000);
            }
        }
        
        // Auto-save configuration
        function autoSaveConfig() {
            const config = {
                model: document.getElementById('model').value,
                temperature: document.getElementById('temperature').value,
                maxTokens: document.getElementById('maxTokens').value,
                topP: document.getElementById('topP').value,
                freqPenalty: document.getElementById('freqPenalty').value,
                presPenalty: document.getElementById('presPenalty').value,
                basePrompt: document.getElementById('basePrompt').value,
                personalityPrompt: document.getElementById('personalityPrompt').value,
                memoryContext: document.getElementById('memoryContext').value
            };
            localStorage.setItem('deepseek-config', JSON.stringify(config));
        }
        
        function loadAutoSavedConfig() {
            const saved = localStorage.getItem('deepseek-config');
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    applyConfig(config);
                } catch (error) {
                    console.error('Error loading auto-saved config:', error);
                }
            }
        }
        
        // PWA Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZXZlbnQgPT4ge30pOyBzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2FjdGl2YXRlJywgZXZlbnQgPT4ge30pOyBzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2ZldGNoJywgZXZlbnQgPT4ge30pOw==')
                .then(reg => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed'));
        }
        
        // Initialize
        window.addEventListener('load', function() {
            loadAutoSavedConfig();
            loadSavedApiKey();
            loadAutoSavedConversation();
            
            // Show share button on mobile
            if (navigator.share) {
                document.getElementById('shareBtn').style.display = 'block';
            }
            
            // Auto-save on changes
            ['model', 'temperature', 'maxTokens', 'topP', 'freqPenalty', 'presPenalty', 'basePrompt', 'personalityPrompt', 'memoryContext'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', autoSaveConfig);
                    element.addEventListener('input', autoSaveConfig);
                }
            });
            
            // Handle mobile keyboard
            handleMobileKeyboard();
        });

        function handleMobileKeyboard() {
            const messageInput = document.getElementById('messageInput');
            const chatContainer = document.getElementById('chatContainer');
            
            // Only auto-scroll when input is focused, don't force scroll otherwise
            messageInput.addEventListener('focus', function() {
                setTimeout(() => {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }, 300);
            });
            
            // Handle viewport height changes (keyboard open/close)
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', () => {
                    const keyboardHeight = window.innerHeight - window.visualViewport.height;
                    if (keyboardHeight > 0) {
                        // Keyboard is open - only adjust if input is focused
                        if (document.activeElement === messageInput) {
                            document.body.style.paddingBottom = keyboardHeight + 'px';
                            setTimeout(() => {
                                chatContainer.scrollTop = chatContainer.scrollHeight;
                            }, 100);
                        }
                    } else {
                        // Keyboard is closed
                        document.body.style.paddingBottom = 'env(safe-area-inset-bottom)';
                    }
                });
            }
            
            // Fix scroll behavior - ensure chat container can scroll freely
            chatContainer.addEventListener('touchstart', function(e) {
                // Allow normal scrolling
                e.stopPropagation();
            }, { passive: true });
            
            chatContainer.addEventListener('touchmove', function(e) {
                // Allow normal scrolling
                e.stopPropagation();
            }, { passive: true });
        }
        
        // Event listeners
        document.getElementById('messageInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        document.getElementById('apiKey').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                setApiKey();
            }
        });

        document.getElementById('messageInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
    </script>
</body>
</html>